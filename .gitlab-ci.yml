stages:
  - build
  - test
  - deploy

variables:
  BUILD_DIR: build_output
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend
  MODELS_DIR: models

# -------------------------------
# 1. Build Stage
# -------------------------------
build-job:
  stage: build
  image: node:18
  services: []
  before_script:
    # Install frontend dependencies
    - cd $FRONTEND_DIR
    - npm ci
  script:
    # Build frontend
    - npm run build
    # Return to project root
    - cd ..
    # Install backend dependencies
    - pip install -r $BACKEND_DIR/requirements.txt
    # Prepare build output directory
    - mkdir -p $BUILD_DIR
    # Copy backend excluding models directory
    - rsync -av --exclude="$MODELS_DIR/" $BACKEND_DIR/ $BUILD_DIR/backend/
    # Copy built frontend files
    - rsync -av $FRONTEND_DIR/build/ $BUILD_DIR/frontend/
  artifacts:
    paths:
      - $BUILD_DIR
    expire_in: 1 week
  only:
    - main
    - master

# -------------------------------
# 2. Test Stage
# -------------------------------
test-job:
  stage: test
  image: python:3.9
  before_script:
    - pip install -r $BACKEND_DIR/requirements.txt
  script:
    # Run backend tests
    - if [ -d "$BACKEND_DIR/tests" ]; then pytest $BACKEND_DIR/tests; else echo "No backend tests found."; fi
    # Run frontend lint
    - cd $FRONTEND_DIR
    - if [ -f "package.json" ]; then npm run lint || echo "No lint script defined."; fi
  only:
    - main
    - master

# -------------------------------
# 3. Deploy Stage
# -------------------------------
deploy-job:
  stage: deploy
  image: alpine:latest
  script:
    # Example deployment using rsync
    # Replace /deploy/path/ with your actual deployment directory or remote target
    - echo "Deploying build output, excluding models directory..."
    - rsync -av --exclude='models/' $BUILD_DIR/ /deploy/path/
    - echo "Deployment completed successfully."
  environment:
    name: production
  only:
    - main
    - master